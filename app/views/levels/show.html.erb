<div class="row-fluid">
  <div class="span11" id='game'>
  </div>
  <div class="span1">
    <p>
		  Level: <%= @level.id %>
    </p>
    <p>
		  Score: <span id='score'>0</span>
    </p>
    <p>
		  Keys: <span id='keys'></span>
    </p>
    <div id ='log'>
    </div>
  </div>
</div>

<script src="http://mrdoob.github.com/three.js/examples/fonts/helvetiker_regular.typeface.js"></script>
<script>
  
	// Initialise level data
	Level.addBlocks(<%= @level.blocks.to_json %>);
	Level.block_texture = "<%= @level.theme.texture_block %>";
  Level.sky_texture = "<%= @level.theme.texture_sky %>";
  Level.ball_texture = "<%= @level.theme.texture_ball %>";
		
  // Position player
  Player.start_at(<%=@level.start['position'][0]%>, <%=@level.start['position'][1]%>, <%=@level.start['position'][2]%>);
    
	// Load entities
	<% @level.entities.each do |entity| %>
		new_entity = new Entity();
		new_entity.geometry_code = "<%= j(Entity.find_by_name(entity['type']).mesh.html_safe) %>";
		new_entity.animate_code = "<%= j(Entity.find_by_name(entity['type']).animate.html_safe) %>";
		new_entity.collide_code = "<%= j(Entity.find_by_name(entity['type']).collide.html_safe) %>";
		new_entity.pickup = <%= Entity.find_by_name(entity['type']).pickup %>;
		new_entity.surface = "<%= entity['surface'] %>";
		new_entity.position = new THREE.Vector3(<%= entity['position'][0] %>, <%= entity['position'][1] %>, <%= entity['position'][2] %>);
		<%= "Level.keys_required += 1;" if entity['type'] == "Key" %>
    Level.entities.push(new_entity);
	<% end %>

  // Update display now entities are loaded
	Level.updateKeyDisplay();

  // Set up the engine
  Engine.init();

  // Animation loop
  function animate() {
		requestAnimationFrame(animate);
    Engine.animate();
  }

  // Start animation loop
  animate();

  // Level complete handler
	function levelComplete() {
		if (Level.gotAllKeys() == true) {
		  Utility.log("LEVEL COMPLETE");
		  jQuery.ajax('<%= world_level_scores_path(@world, @level) %>',{
										type: 'POST',
										data: {score: Level.score}
									});
		}
	}



</script>